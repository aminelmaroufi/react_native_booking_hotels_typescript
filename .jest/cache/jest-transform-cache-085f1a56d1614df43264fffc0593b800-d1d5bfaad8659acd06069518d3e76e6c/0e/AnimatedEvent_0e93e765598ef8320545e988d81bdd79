4ea15d6fd4074fdf543ece8ec81c4b7f
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));
var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));
var AnimatedValue = require('./nodes/AnimatedValue');
var NativeAnimatedHelper = require('./NativeAnimatedHelper');
var ReactNative = require('../Renderer/shims/ReactNative');
var invariant = require('invariant');
var _require = require('./NativeAnimatedHelper'),
  shouldUseNativeDriver = _require.shouldUseNativeDriver;
function attachNativeEvent(viewRef, eventName, argMapping) {
  var eventMappings = [];
  var traverse = function traverse(value, path) {
    if (value instanceof AnimatedValue) {
      value.__makeNative();
      eventMappings.push({
        nativeEventPath: path,
        animatedValueTag: value.__getNativeTag()
      });
    } else if (typeof value === 'object') {
      for (var _key in value) {
        traverse(value[_key], path.concat(_key));
      }
    }
  };
  invariant(argMapping[0] && argMapping[0].nativeEvent, 'Native driven events only support animated values contained inside `nativeEvent`.');
  traverse(argMapping[0].nativeEvent, []);
  var viewTag = ReactNative.findNodeHandle(viewRef);
  if (viewTag != null) {
    eventMappings.forEach(function (mapping) {
      NativeAnimatedHelper.API.addAnimatedEventToView(viewTag, eventName, mapping);
    });
  }
  return {
    detach: function detach() {
      if (viewTag != null) {
        eventMappings.forEach(function (mapping) {
          NativeAnimatedHelper.API.removeAnimatedEventFromView(viewTag, eventName, mapping.animatedValueTag);
        });
      }
    }
  };
}
function validateMapping(argMapping, args) {
  var validate = function validate(recMapping, recEvt, key) {
    if (recMapping instanceof AnimatedValue) {
      invariant(typeof recEvt === 'number', 'Bad mapping of event key ' + key + ', should be number but got ' + typeof recEvt);
      return;
    }
    if (typeof recEvt === 'number') {
      invariant(recMapping instanceof AnimatedValue, 'Bad mapping of type ' + typeof recMapping + ' for key ' + key + ', event value must map to AnimatedValue');
      return;
    }
    invariant(typeof recMapping === 'object', 'Bad mapping of type ' + typeof recMapping + ' for key ' + key);
    invariant(typeof recEvt === 'object', 'Bad event of type ' + typeof recEvt + ' for key ' + key);
    for (var mappingKey in recMapping) {
      validate(recMapping[mappingKey], recEvt[mappingKey], mappingKey);
    }
  };
  invariant(args.length >= argMapping.length, 'Event has less arguments than mapping');
  argMapping.forEach(function (mapping, idx) {
    validate(mapping, args[idx], 'arg' + idx);
  });
}
var AnimatedEvent = function () {
  function AnimatedEvent(argMapping, config) {
    (0, _classCallCheck2.default)(this, AnimatedEvent);
    this._listeners = [];
    this._argMapping = argMapping;
    if (config == null) {
      console.warn('Animated.event now requires a second argument for options');
      config = {
        useNativeDriver: false
      };
    }
    if (config.listener) {
      this.__addListener(config.listener);
    }
    this._callListeners = this._callListeners.bind(this);
    this._attachedEvent = null;
    this.__isNative = shouldUseNativeDriver(config);
  }
  (0, _createClass2.default)(AnimatedEvent, [{
    key: "__addListener",
    value: function __addListener(callback) {
      this._listeners.push(callback);
    }
  }, {
    key: "__removeListener",
    value: function __removeListener(callback) {
      this._listeners = this._listeners.filter(function (listener) {
        return listener !== callback;
      });
    }
  }, {
    key: "__attach",
    value: function __attach(viewRef, eventName) {
      invariant(this.__isNative, 'Only native driven events need to be attached.');
      this._attachedEvent = attachNativeEvent(viewRef, eventName, this._argMapping);
    }
  }, {
    key: "__detach",
    value: function __detach(viewTag, eventName) {
      invariant(this.__isNative, 'Only native driven events need to be detached.');
      this._attachedEvent && this._attachedEvent.detach();
    }
  }, {
    key: "__getHandler",
    value: function __getHandler() {
      var _this = this;
      if (this.__isNative) {
        if (__DEV__) {
          var _validatedMapping = false;
          return function () {
            for (var _len = arguments.length, args = new Array(_len), _key2 = 0; _key2 < _len; _key2++) {
              args[_key2] = arguments[_key2];
            }
            if (!_validatedMapping) {
              validateMapping(_this._argMapping, args);
              _validatedMapping = true;
            }
            _this._callListeners.apply(_this, args);
          };
        } else {
          return this._callListeners;
        }
      }
      var validatedMapping = false;
      return function () {
        for (var _len2 = arguments.length, args = new Array(_len2), _key3 = 0; _key3 < _len2; _key3++) {
          args[_key3] = arguments[_key3];
        }
        if (__DEV__ && !validatedMapping) {
          validateMapping(_this._argMapping, args);
          validatedMapping = true;
        }
        var traverse = function traverse(recMapping, recEvt, key) {
          if (recMapping instanceof AnimatedValue) {
            if (typeof recEvt === 'number') {
              recMapping.setValue(recEvt);
            }
          } else if (typeof recMapping === 'object') {
            for (var mappingKey in recMapping) {
              traverse(recMapping[mappingKey], recEvt[mappingKey], mappingKey);
            }
          }
        };
        _this._argMapping.forEach(function (mapping, idx) {
          traverse(mapping, args[idx], 'arg' + idx);
        });
        _this._callListeners.apply(_this, args);
      };
    }
  }, {
    key: "_callListeners",
    value: function _callListeners() {
      for (var _len3 = arguments.length, args = new Array(_len3), _key4 = 0; _key4 < _len3; _key4++) {
        args[_key4] = arguments[_key4];
      }
      this._listeners.forEach(function (listener) {
        return listener.apply(void 0, args);
      });
    }
  }]);
  return AnimatedEvent;
}();
module.exports = {
  AnimatedEvent: AnimatedEvent,
  attachNativeEvent: attachNativeEvent
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9jbGFzc0NhbGxDaGVjazIiLCJfY3JlYXRlQ2xhc3MyIiwiQW5pbWF0ZWRWYWx1ZSIsIk5hdGl2ZUFuaW1hdGVkSGVscGVyIiwiUmVhY3ROYXRpdmUiLCJpbnZhcmlhbnQiLCJfcmVxdWlyZSIsInNob3VsZFVzZU5hdGl2ZURyaXZlciIsImF0dGFjaE5hdGl2ZUV2ZW50Iiwidmlld1JlZiIsImV2ZW50TmFtZSIsImFyZ01hcHBpbmciLCJldmVudE1hcHBpbmdzIiwidHJhdmVyc2UiLCJ2YWx1ZSIsInBhdGgiLCJfX21ha2VOYXRpdmUiLCJwdXNoIiwibmF0aXZlRXZlbnRQYXRoIiwiYW5pbWF0ZWRWYWx1ZVRhZyIsIl9fZ2V0TmF0aXZlVGFnIiwia2V5IiwiY29uY2F0IiwibmF0aXZlRXZlbnQiLCJ2aWV3VGFnIiwiZmluZE5vZGVIYW5kbGUiLCJmb3JFYWNoIiwibWFwcGluZyIsIkFQSSIsImFkZEFuaW1hdGVkRXZlbnRUb1ZpZXciLCJkZXRhY2giLCJyZW1vdmVBbmltYXRlZEV2ZW50RnJvbVZpZXciLCJ2YWxpZGF0ZU1hcHBpbmciLCJhcmdzIiwidmFsaWRhdGUiLCJyZWNNYXBwaW5nIiwicmVjRXZ0IiwibWFwcGluZ0tleSIsImxlbmd0aCIsImlkeCIsIkFuaW1hdGVkRXZlbnQiLCJjb25maWciLCJkZWZhdWx0IiwiX2xpc3RlbmVycyIsIl9hcmdNYXBwaW5nIiwiY29uc29sZSIsIndhcm4iLCJ1c2VOYXRpdmVEcml2ZXIiLCJsaXN0ZW5lciIsIl9fYWRkTGlzdGVuZXIiLCJfY2FsbExpc3RlbmVycyIsImJpbmQiLCJfYXR0YWNoZWRFdmVudCIsIl9faXNOYXRpdmUiLCJjYWxsYmFjayIsIl9fcmVtb3ZlTGlzdGVuZXIiLCJmaWx0ZXIiLCJfX2F0dGFjaCIsIl9fZGV0YWNoIiwiX19nZXRIYW5kbGVyIiwiX3RoaXMiLCJfX0RFVl9fIiwidmFsaWRhdGVkTWFwcGluZyIsIl9sZW4iLCJhcmd1bWVudHMiLCJBcnJheSIsIl9rZXkyIiwiYXBwbHkiLCJfbGVuMiIsIl9rZXkzIiwic2V0VmFsdWUiLCJfbGVuMyIsIl9rZXk0IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbIkFuaW1hdGVkRXZlbnQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICogQGZvcm1hdFxuICovXG5cbid1c2Ugc3RyaWN0JztcblxuY29uc3QgQW5pbWF0ZWRWYWx1ZSA9IHJlcXVpcmUoJy4vbm9kZXMvQW5pbWF0ZWRWYWx1ZScpO1xuY29uc3QgTmF0aXZlQW5pbWF0ZWRIZWxwZXIgPSByZXF1aXJlKCcuL05hdGl2ZUFuaW1hdGVkSGVscGVyJyk7XG5jb25zdCBSZWFjdE5hdGl2ZSA9IHJlcXVpcmUoJy4uL1JlbmRlcmVyL3NoaW1zL1JlYWN0TmF0aXZlJyk7XG5cbmNvbnN0IGludmFyaWFudCA9IHJlcXVpcmUoJ2ludmFyaWFudCcpO1xuXG5jb25zdCB7c2hvdWxkVXNlTmF0aXZlRHJpdmVyfSA9IHJlcXVpcmUoJy4vTmF0aXZlQW5pbWF0ZWRIZWxwZXInKTtcblxuZXhwb3J0IHR5cGUgTWFwcGluZyA9IHtba2V5OiBzdHJpbmddOiBNYXBwaW5nLCAuLi59IHwgQW5pbWF0ZWRWYWx1ZTtcbmV4cG9ydCB0eXBlIEV2ZW50Q29uZmlnID0ge1xuICBsaXN0ZW5lcj86ID9GdW5jdGlvbixcbiAgdXNlTmF0aXZlRHJpdmVyOiBib29sZWFuLFxufTtcblxuZnVuY3Rpb24gYXR0YWNoTmF0aXZlRXZlbnQoXG4gIHZpZXdSZWY6IGFueSxcbiAgZXZlbnROYW1lOiBzdHJpbmcsXG4gIGFyZ01hcHBpbmc6ICRSZWFkT25seUFycmF5PD9NYXBwaW5nPixcbik6IHtkZXRhY2g6ICgpID0+IHZvaWR9IHtcbiAgLy8gRmluZCBhbmltYXRlZCB2YWx1ZXMgaW4gYGFyZ01hcHBpbmdgIGFuZCBjcmVhdGUgYW4gYXJyYXkgcmVwcmVzZW50aW5nIHRoZWlyXG4gIC8vIGtleSBwYXRoIGluc2lkZSB0aGUgYG5hdGl2ZUV2ZW50YCBvYmplY3QuIEV4LjogWydjb250ZW50T2Zmc2V0JywgJ3gnXS5cbiAgY29uc3QgZXZlbnRNYXBwaW5ncyA9IFtdO1xuXG4gIGNvbnN0IHRyYXZlcnNlID0gKHZhbHVlLCBwYXRoKSA9PiB7XG4gICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQW5pbWF0ZWRWYWx1ZSkge1xuICAgICAgdmFsdWUuX19tYWtlTmF0aXZlKCk7XG5cbiAgICAgIGV2ZW50TWFwcGluZ3MucHVzaCh7XG4gICAgICAgIG5hdGl2ZUV2ZW50UGF0aDogcGF0aCxcbiAgICAgICAgYW5pbWF0ZWRWYWx1ZVRhZzogdmFsdWUuX19nZXROYXRpdmVUYWcoKSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgICAgZm9yIChjb25zdCBrZXkgaW4gdmFsdWUpIHtcbiAgICAgICAgdHJhdmVyc2UodmFsdWVba2V5XSwgcGF0aC5jb25jYXQoa2V5KSk7XG4gICAgICB9XG4gICAgfVxuICB9O1xuXG4gIGludmFyaWFudChcbiAgICBhcmdNYXBwaW5nWzBdICYmIGFyZ01hcHBpbmdbMF0ubmF0aXZlRXZlbnQsXG4gICAgJ05hdGl2ZSBkcml2ZW4gZXZlbnRzIG9ubHkgc3VwcG9ydCBhbmltYXRlZCB2YWx1ZXMgY29udGFpbmVkIGluc2lkZSBgbmF0aXZlRXZlbnRgLicsXG4gICk7XG5cbiAgLy8gQXNzdW1lIHRoYXQgdGhlIGV2ZW50IGNvbnRhaW5pbmcgYG5hdGl2ZUV2ZW50YCBpcyBhbHdheXMgdGhlIGZpcnN0IGFyZ3VtZW50LlxuICB0cmF2ZXJzZShhcmdNYXBwaW5nWzBdLm5hdGl2ZUV2ZW50LCBbXSk7XG5cbiAgY29uc3Qgdmlld1RhZyA9IFJlYWN0TmF0aXZlLmZpbmROb2RlSGFuZGxlKHZpZXdSZWYpO1xuICBpZiAodmlld1RhZyAhPSBudWxsKSB7XG4gICAgZXZlbnRNYXBwaW5ncy5mb3JFYWNoKG1hcHBpbmcgPT4ge1xuICAgICAgTmF0aXZlQW5pbWF0ZWRIZWxwZXIuQVBJLmFkZEFuaW1hdGVkRXZlbnRUb1ZpZXcoXG4gICAgICAgIHZpZXdUYWcsXG4gICAgICAgIGV2ZW50TmFtZSxcbiAgICAgICAgbWFwcGluZyxcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGRldGFjaCgpIHtcbiAgICAgIGlmICh2aWV3VGFnICE9IG51bGwpIHtcbiAgICAgICAgZXZlbnRNYXBwaW5ncy5mb3JFYWNoKG1hcHBpbmcgPT4ge1xuICAgICAgICAgIE5hdGl2ZUFuaW1hdGVkSGVscGVyLkFQSS5yZW1vdmVBbmltYXRlZEV2ZW50RnJvbVZpZXcoXG4gICAgICAgICAgICB2aWV3VGFnLFxuICAgICAgICAgICAgZXZlbnROYW1lLFxuICAgICAgICAgICAgLy8gJEZsb3dGaXhNZVtpbmNvbXBhdGlibGUtY2FsbF1cbiAgICAgICAgICAgIG1hcHBpbmcuYW5pbWF0ZWRWYWx1ZVRhZyxcbiAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9LFxuICB9O1xufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZU1hcHBpbmcoYXJnTWFwcGluZywgYXJncykge1xuICBjb25zdCB2YWxpZGF0ZSA9IChyZWNNYXBwaW5nLCByZWNFdnQsIGtleSkgPT4ge1xuICAgIGlmIChyZWNNYXBwaW5nIGluc3RhbmNlb2YgQW5pbWF0ZWRWYWx1ZSkge1xuICAgICAgaW52YXJpYW50KFxuICAgICAgICB0eXBlb2YgcmVjRXZ0ID09PSAnbnVtYmVyJyxcbiAgICAgICAgJ0JhZCBtYXBwaW5nIG9mIGV2ZW50IGtleSAnICtcbiAgICAgICAgICBrZXkgK1xuICAgICAgICAgICcsIHNob3VsZCBiZSBudW1iZXIgYnV0IGdvdCAnICtcbiAgICAgICAgICB0eXBlb2YgcmVjRXZ0LFxuICAgICAgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiByZWNFdnQgPT09ICdudW1iZXInKSB7XG4gICAgICBpbnZhcmlhbnQoXG4gICAgICAgIHJlY01hcHBpbmcgaW5zdGFuY2VvZiBBbmltYXRlZFZhbHVlLFxuICAgICAgICAnQmFkIG1hcHBpbmcgb2YgdHlwZSAnICtcbiAgICAgICAgICB0eXBlb2YgcmVjTWFwcGluZyArXG4gICAgICAgICAgJyBmb3Iga2V5ICcgK1xuICAgICAgICAgIGtleSArXG4gICAgICAgICAgJywgZXZlbnQgdmFsdWUgbXVzdCBtYXAgdG8gQW5pbWF0ZWRWYWx1ZScsXG4gICAgICApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpbnZhcmlhbnQoXG4gICAgICB0eXBlb2YgcmVjTWFwcGluZyA9PT0gJ29iamVjdCcsXG4gICAgICAnQmFkIG1hcHBpbmcgb2YgdHlwZSAnICsgdHlwZW9mIHJlY01hcHBpbmcgKyAnIGZvciBrZXkgJyArIGtleSxcbiAgICApO1xuICAgIGludmFyaWFudChcbiAgICAgIHR5cGVvZiByZWNFdnQgPT09ICdvYmplY3QnLFxuICAgICAgJ0JhZCBldmVudCBvZiB0eXBlICcgKyB0eXBlb2YgcmVjRXZ0ICsgJyBmb3Iga2V5ICcgKyBrZXksXG4gICAgKTtcbiAgICBmb3IgKGNvbnN0IG1hcHBpbmdLZXkgaW4gcmVjTWFwcGluZykge1xuICAgICAgdmFsaWRhdGUocmVjTWFwcGluZ1ttYXBwaW5nS2V5XSwgcmVjRXZ0W21hcHBpbmdLZXldLCBtYXBwaW5nS2V5KTtcbiAgICB9XG4gIH07XG5cbiAgaW52YXJpYW50KFxuICAgIGFyZ3MubGVuZ3RoID49IGFyZ01hcHBpbmcubGVuZ3RoLFxuICAgICdFdmVudCBoYXMgbGVzcyBhcmd1bWVudHMgdGhhbiBtYXBwaW5nJyxcbiAgKTtcbiAgYXJnTWFwcGluZy5mb3JFYWNoKChtYXBwaW5nLCBpZHgpID0+IHtcbiAgICB2YWxpZGF0ZShtYXBwaW5nLCBhcmdzW2lkeF0sICdhcmcnICsgaWR4KTtcbiAgfSk7XG59XG5cbmNsYXNzIEFuaW1hdGVkRXZlbnQge1xuICBfYXJnTWFwcGluZzogJFJlYWRPbmx5QXJyYXk8P01hcHBpbmc+O1xuICBfbGlzdGVuZXJzOiBBcnJheTxGdW5jdGlvbj4gPSBbXTtcbiAgX2NhbGxMaXN0ZW5lcnM6IEZ1bmN0aW9uO1xuICBfYXR0YWNoZWRFdmVudDogP3tkZXRhY2g6ICgpID0+IHZvaWQsIC4uLn07XG4gIF9faXNOYXRpdmU6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoYXJnTWFwcGluZzogJFJlYWRPbmx5QXJyYXk8P01hcHBpbmc+LCBjb25maWc6IEV2ZW50Q29uZmlnKSB7XG4gICAgdGhpcy5fYXJnTWFwcGluZyA9IGFyZ01hcHBpbmc7XG5cbiAgICBpZiAoY29uZmlnID09IG51bGwpIHtcbiAgICAgIGNvbnNvbGUud2FybignQW5pbWF0ZWQuZXZlbnQgbm93IHJlcXVpcmVzIGEgc2Vjb25kIGFyZ3VtZW50IGZvciBvcHRpb25zJyk7XG4gICAgICBjb25maWcgPSB7dXNlTmF0aXZlRHJpdmVyOiBmYWxzZX07XG4gICAgfVxuXG4gICAgaWYgKGNvbmZpZy5saXN0ZW5lcikge1xuICAgICAgdGhpcy5fX2FkZExpc3RlbmVyKGNvbmZpZy5saXN0ZW5lcik7XG4gICAgfVxuICAgIHRoaXMuX2NhbGxMaXN0ZW5lcnMgPSB0aGlzLl9jYWxsTGlzdGVuZXJzLmJpbmQodGhpcyk7XG4gICAgdGhpcy5fYXR0YWNoZWRFdmVudCA9IG51bGw7XG4gICAgdGhpcy5fX2lzTmF0aXZlID0gc2hvdWxkVXNlTmF0aXZlRHJpdmVyKGNvbmZpZyk7XG4gIH1cblxuICBfX2FkZExpc3RlbmVyKGNhbGxiYWNrOiBGdW5jdGlvbik6IHZvaWQge1xuICAgIHRoaXMuX2xpc3RlbmVycy5wdXNoKGNhbGxiYWNrKTtcbiAgfVxuXG4gIF9fcmVtb3ZlTGlzdGVuZXIoY2FsbGJhY2s6IEZ1bmN0aW9uKTogdm9pZCB7XG4gICAgdGhpcy5fbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzLmZpbHRlcihsaXN0ZW5lciA9PiBsaXN0ZW5lciAhPT0gY2FsbGJhY2spO1xuICB9XG5cbiAgX19hdHRhY2godmlld1JlZjogYW55LCBldmVudE5hbWU6IHN0cmluZykge1xuICAgIGludmFyaWFudChcbiAgICAgIHRoaXMuX19pc05hdGl2ZSxcbiAgICAgICdPbmx5IG5hdGl2ZSBkcml2ZW4gZXZlbnRzIG5lZWQgdG8gYmUgYXR0YWNoZWQuJyxcbiAgICApO1xuXG4gICAgdGhpcy5fYXR0YWNoZWRFdmVudCA9IGF0dGFjaE5hdGl2ZUV2ZW50KFxuICAgICAgdmlld1JlZixcbiAgICAgIGV2ZW50TmFtZSxcbiAgICAgIHRoaXMuX2FyZ01hcHBpbmcsXG4gICAgKTtcbiAgfVxuXG4gIF9fZGV0YWNoKHZpZXdUYWc6IGFueSwgZXZlbnROYW1lOiBzdHJpbmcpIHtcbiAgICBpbnZhcmlhbnQoXG4gICAgICB0aGlzLl9faXNOYXRpdmUsXG4gICAgICAnT25seSBuYXRpdmUgZHJpdmVuIGV2ZW50cyBuZWVkIHRvIGJlIGRldGFjaGVkLicsXG4gICAgKTtcblxuICAgIHRoaXMuX2F0dGFjaGVkRXZlbnQgJiYgdGhpcy5fYXR0YWNoZWRFdmVudC5kZXRhY2goKTtcbiAgfVxuXG4gIF9fZ2V0SGFuZGxlcigpOiBhbnkgfCAoKC4uLmFyZ3M6IGFueSkgPT4gdm9pZCkge1xuICAgIGlmICh0aGlzLl9faXNOYXRpdmUpIHtcbiAgICAgIGlmIChfX0RFVl9fKSB7XG4gICAgICAgIGxldCB2YWxpZGF0ZWRNYXBwaW5nID0gZmFsc2U7XG4gICAgICAgIHJldHVybiAoLi4uYXJnczogYW55KSA9PiB7XG4gICAgICAgICAgaWYgKCF2YWxpZGF0ZWRNYXBwaW5nKSB7XG4gICAgICAgICAgICB2YWxpZGF0ZU1hcHBpbmcodGhpcy5fYXJnTWFwcGluZywgYXJncyk7XG4gICAgICAgICAgICB2YWxpZGF0ZWRNYXBwaW5nID0gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5fY2FsbExpc3RlbmVycyguLi5hcmdzKTtcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jYWxsTGlzdGVuZXJzO1xuICAgICAgfVxuICAgIH1cblxuICAgIGxldCB2YWxpZGF0ZWRNYXBwaW5nID0gZmFsc2U7XG4gICAgcmV0dXJuICguLi5hcmdzOiBhbnkpID0+IHtcbiAgICAgIGlmIChfX0RFVl9fICYmICF2YWxpZGF0ZWRNYXBwaW5nKSB7XG4gICAgICAgIHZhbGlkYXRlTWFwcGluZyh0aGlzLl9hcmdNYXBwaW5nLCBhcmdzKTtcbiAgICAgICAgdmFsaWRhdGVkTWFwcGluZyA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHRyYXZlcnNlID0gKHJlY01hcHBpbmcsIHJlY0V2dCwga2V5KSA9PiB7XG4gICAgICAgIGlmIChyZWNNYXBwaW5nIGluc3RhbmNlb2YgQW5pbWF0ZWRWYWx1ZSkge1xuICAgICAgICAgIGlmICh0eXBlb2YgcmVjRXZ0ID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgcmVjTWFwcGluZy5zZXRWYWx1ZShyZWNFdnQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcmVjTWFwcGluZyA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IG1hcHBpbmdLZXkgaW4gcmVjTWFwcGluZykge1xuICAgICAgICAgICAgLyogJEZsb3dGaXhNZVtwcm9wLW1pc3NpbmddICg+PTAuMTIwLjApIFRoaXMgY29tbWVudCBzdXBwcmVzc2VzIGFuXG4gICAgICAgICAgICAgKiBlcnJvciBmb3VuZCB3aGVuIEZsb3cgdjAuMTIwIHdhcyBkZXBsb3llZC4gVG8gc2VlIHRoZSBlcnJvcixcbiAgICAgICAgICAgICAqIGRlbGV0ZSB0aGlzIGNvbW1lbnQgYW5kIHJ1biBGbG93LiAqL1xuICAgICAgICAgICAgdHJhdmVyc2UocmVjTWFwcGluZ1ttYXBwaW5nS2V5XSwgcmVjRXZ0W21hcHBpbmdLZXldLCBtYXBwaW5nS2V5KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICB0aGlzLl9hcmdNYXBwaW5nLmZvckVhY2goKG1hcHBpbmcsIGlkeCkgPT4ge1xuICAgICAgICB0cmF2ZXJzZShtYXBwaW5nLCBhcmdzW2lkeF0sICdhcmcnICsgaWR4KTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLl9jYWxsTGlzdGVuZXJzKC4uLmFyZ3MpO1xuICAgIH07XG4gIH1cblxuICBfY2FsbExpc3RlbmVycyguLi5hcmdzOiBhbnkpIHtcbiAgICB0aGlzLl9saXN0ZW5lcnMuZm9yRWFjaChsaXN0ZW5lciA9PiBsaXN0ZW5lciguLi5hcmdzKSk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7QW5pbWF0ZWRFdmVudCwgYXR0YWNoTmF0aXZlRXZlbnR9O1xuIl0sIm1hcHBpbmdzIjoiQUFVQSxZQUFZOztBQUFDLElBQUFBLHNCQUFBLEdBQUFDLE9BQUE7QUFBQSxJQUFBQyxnQkFBQSxHQUFBRixzQkFBQSxDQUFBQyxPQUFBO0FBQUEsSUFBQUUsYUFBQSxHQUFBSCxzQkFBQSxDQUFBQyxPQUFBO0FBRWIsSUFBTUcsYUFBYSxHQUFHSCxPQUFPLENBQUMsdUJBQXVCLENBQUM7QUFDdEQsSUFBTUksb0JBQW9CLEdBQUdKLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQztBQUM5RCxJQUFNSyxXQUFXLEdBQUdMLE9BQU8sQ0FBQywrQkFBK0IsQ0FBQztBQUU1RCxJQUFNTSxTQUFTLEdBQUdOLE9BQU8sQ0FBQyxXQUFXLENBQUM7QUFFdEMsSUFBQU8sUUFBQSxHQUFnQ1AsT0FBTyxDQUFDLHdCQUF3QixDQUFDO0VBQTFEUSxxQkFBcUIsR0FBQUQsUUFBQSxDQUFyQkMscUJBQXFCO0FBUTVCLFNBQVNDLGlCQUFpQkEsQ0FDeEJDLE9BQVksRUFDWkMsU0FBaUIsRUFDakJDLFVBQW9D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